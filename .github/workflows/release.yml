name: Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ä»¥vå¼€å¤´çš„tagï¼Œå¦‚v1.0.0

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ç”¨äºç”Ÿæˆchangelog

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Install dependencies
        run: go mod download

      - name: Run tests
        run: go test -v ./...

      - name: Run security scan
        uses: securecodewarrior/github-action-add-sarif@v1
        with:
          sarif-file: 'results.sarif'
        continue-on-error: true

      - name: Build for multiple platforms
        run: |
          # æ„å»ºåµŒå…¥å¼ç‰ˆæœ¬ - é™æ€èµ„æºå·²æ‰“åŒ…åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œæ— éœ€å•ç‹¬éƒ¨ç½²é™æ€æ–‡ä»¶
          echo "Building embedded versions with static resources..."
          
          # Linux AMD64
          GOOS=linux GOARCH=amd64 go build -ldflags "-X main.Version=${{ steps.version.outputs.version }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X main.BuildCommit=${{ github.sha }}" -o dist/proxy-test-tool-linux-amd64
          
          # Linux ARM64
          GOOS=linux GOARCH=arm64 go build -ldflags "-X main.Version=${{ steps.version.outputs.version }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X main.BuildCommit=${{ github.sha }}" -o dist/proxy-test-tool-linux-arm64
          
          # macOS AMD64
          GOOS=darwin GOARCH=amd64 go build -ldflags "-X main.Version=${{ steps.version.outputs.version }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X main.BuildCommit=${{ github.sha }}" -o dist/proxy-test-tool-darwin-amd64
          
          # macOS ARM64
          GOOS=darwin GOARCH=arm64 go build -ldflags "-X main.Version=${{ steps.version.outputs.version }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X main.BuildCommit=${{ github.sha }}" -o dist/proxy-test-tool-darwin-arm64
          
          # Windows AMD64
          GOOS=windows GOARCH=amd64 go build -ldflags "-X main.Version=${{ steps.version.outputs.version }} -X main.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) -X main.BuildCommit=${{ github.sha }}" -o dist/proxy-test-tool-windows-amd64.exe

      - name: Create checksums
        run: |
          cd dist
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Generate changelog
        id: changelog
        run: |
          # è·å–å½“å‰tagå’Œä¸Šä¸€ä¸ªtag
          CURRENT_TAG=${{ steps.version.outputs.version }}
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 $CURRENT_TAG^ 2>/dev/null || echo "")
          
          echo "Current tag: $CURRENT_TAG"
          echo "Previous tag: $PREVIOUS_TAG"
          
          # ç”Ÿæˆchangelog
          if [ -z "$PREVIOUS_TAG" ]; then
            # å¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ªtagï¼Œè·å–æ‰€æœ‰æäº¤
            CHANGELOG=$(git log --pretty=format:"* %s (%h)" --reverse)
          else
            # è·å–ä¸¤ä¸ªtagä¹‹é—´çš„æäº¤
            CHANGELOG=$(git log --pretty=format:"* %s (%h)" --reverse $PREVIOUS_TAG..$CURRENT_TAG)
          fi
          
          # ä¿å­˜changelogåˆ°æ–‡ä»¶
          echo "# ç‰ˆæœ¬ $CURRENT_TAG æ›´æ–°æ—¥å¿—" > changelog.md
          echo "" >> changelog.md
          echo "## ğŸš€ æ–°åŠŸèƒ½å’Œæ”¹è¿›" >> changelog.md
          echo "" >> changelog.md
          echo "$CHANGELOG" | grep -E "(feat|feature|add|æ–°å¢|æ·»åŠ |å¢åŠ )" >> changelog.md || echo "æ— " >> changelog.md
          echo "" >> changelog.md
          echo "## ğŸ› é”™è¯¯ä¿®å¤" >> changelog.md
          echo "" >> changelog.md
          echo "$CHANGELOG" | grep -E "(fix|bug|ä¿®å¤|ä¿®æ”¹|ä¼˜åŒ–)" >> changelog.md || echo "æ— " >> changelog.md
          echo "" >> changelog.md
          echo "## ğŸ“ å…¶ä»–æ›´æ”¹" >> changelog.md
          echo "" >> changelog.md
          echo "$CHANGELOG" | grep -vE "(feat|feature|add|æ–°å¢|æ·»åŠ |å¢åŠ |fix|bug|ä¿®å¤|ä¿®æ”¹|ä¼˜åŒ–)" >> changelog.md || echo "æ— " >> changelog.md
          echo "" >> changelog.md
          echo "## ğŸ“¦ æ„å»ºä¿¡æ¯" >> changelog.md
          echo "" >> changelog.md
          echo "- **æ„å»ºæ—¶é—´**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> changelog.md
          echo "- **æäº¤å“ˆå¸Œ**: ${{ github.sha }}" >> changelog.md
          echo "- **Goç‰ˆæœ¬**: $(go version)" >> changelog.md
          echo "" >> changelog.md
          echo "## ğŸ”— ä¸‹è½½é“¾æ¥" >> changelog.md
          echo "" >> changelog.md
          echo "| å¹³å° | æ¶æ„ | ä¸‹è½½é“¾æ¥ |" >> changelog.md
          echo "|------|------|----------|" >> changelog.md
          echo "| Linux | AMD64 | [proxy-test-tool-linux-amd64](https://github.com/${{ github.repository }}/releases/download/$CURRENT_TAG/proxy-test-tool-linux-amd64) |" >> changelog.md
          echo "| Linux | ARM64 | [proxy-test-tool-linux-arm64](https://github.com/${{ github.repository }}/releases/download/$CURRENT_TAG/proxy-test-tool-linux-arm64) |" >> changelog.md
          echo "| macOS | AMD64 | [proxy-test-tool-darwin-amd64](https://github.com/${{ github.repository }}/releases/download/$CURRENT_TAG/proxy-test-tool-darwin-amd64) |" >> changelog.md
          echo "| macOS | ARM64 | [proxy-test-tool-darwin-arm64](https://github.com/${{ github.repository }}/releases/download/$CURRENT_TAG/proxy-test-tool-darwin-arm64) |" >> changelog.md
          echo "| Windows | AMD64 | [proxy-test-tool-windows-amd64.exe](https://github.com/${{ github.repository }}/releases/download/$CURRENT_TAG/proxy-test-tool-windows-amd64.exe) |" >> changelog.md
          echo "" >> changelog.md
          echo "## ğŸ³ Dockeré•œåƒ" >> changelog.md
          echo "" >> changelog.md
          echo "\`\`\`bash" >> changelog.md
          echo "# æ‹‰å–é•œåƒ" >> changelog.md
          echo "docker pull ghcr.io/${{ github.repository }}:$CURRENT_TAG" >> changelog.md
          echo "" >> changelog.md
          echo "# è¿è¡Œå®¹å™¨" >> changelog.md
          echo "docker run -d -p 8080:8080 --name proxy-test-tool ghcr.io/${{ github.repository }}:$CURRENT_TAG" >> changelog.md
          echo "\`\`\`" >> changelog.md
          
          # è¾“å‡ºchangelogå†…å®¹
          cat changelog.md
          
          # å°†changelogä¿å­˜åˆ°è¾“å‡º
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            dist/
            changelog.md

  # æ„å»ºå’Œæ¨é€Dockeré•œåƒ
  docker-build:
    needs: build-and-test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BUILD_VERSION=${{ needs.build-and-test.outputs.version }}
            BUILD_TIME=${{ github.event.head_commit.timestamp }}
            BUILD_COMMIT=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # åˆ›å»ºGitHub Release
  create-release:
    needs: [build-and-test, docker-build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: ./artifacts

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.build-and-test.outputs.version }}
          name: 'Release ${{ needs.build-and-test.outputs.version }}'
          body: ${{ needs.build-and-test.outputs.changelog }}
          draft: false
          prerelease: ${{ contains(needs.build-and-test.outputs.version, '-') }}
          artifacts: |
            artifacts/dist/*
            artifacts/changelog.md
          token: ${{ secrets.GITHUB_TOKEN }}

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆå¯é€‰ï¼‰
  deploy-production:
    needs: [build-and-test, docker-build, create-release]
    runs-on: ubuntu-latest
    if: ${{ !contains(needs.build-and-test.outputs.version, '-') }}  # åªæœ‰æ­£å¼ç‰ˆæœ¬æ‰éƒ¨ç½²
    environment: production
    steps:
      - name: Deploy to production
        run: |
          echo "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
          echo "ç‰ˆæœ¬: ${{ needs.build-and-test.outputs.version }}"
          echo "é•œåƒ: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-test.outputs.version }}"
          # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„éƒ¨ç½²è„šæœ¬
          # ä¾‹å¦‚ï¼škubectl set image deployment/proxy-test-tool proxy-test-tool=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-test.outputs.version }}

  # é€šçŸ¥ç›¸å…³äººå‘˜
  notify:
    needs: [build-and-test, docker-build, create-release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify release status
        run: |
          if [ "${{ needs.create-release.result }}" == "success" ]; then
            echo "âœ… ç‰ˆæœ¬ ${{ needs.build-and-test.outputs.version }} å‘å¸ƒæˆåŠŸï¼"
          else
            echo "âŒ ç‰ˆæœ¬ ${{ needs.build-and-test.outputs.version }} å‘å¸ƒå¤±è´¥ï¼"
          fi
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘ï¼Œå¦‚å‘é€é‚®ä»¶ã€Slackã€å¾®ä¿¡ç­‰
          # ä¾‹å¦‚ï¼šcurl -X POST -H 'Content-type: application/json' --data '{"text":"New release: ${{ needs.build-and-test.outputs.version }}"}' YOUR_WEBHOOK_URL 