# Lint å·¥å…·å†…å­˜é—®é¢˜ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

åœ¨è¿è¡Œ `make lint` æ—¶é‡åˆ°å†…å­˜ä¸è¶³å¯¼è‡´è¿›ç¨‹è¢«æ€æ­»çš„é—®é¢˜ï¼š

```bash
$ make lint
ğŸ” è¿è¡Œgolangci-lintæ£€æŸ¥...
$(go env GOPATH)/bin/golangci-lint run --timeout=5m
Killed
make: *** [Makefile:120ï¼šlint] é”™è¯¯ 137
```

**é”™è¯¯åˆ†æ**ï¼š
- é”™è¯¯ç  137 è¡¨ç¤ºè¿›ç¨‹è¢« SIGKILL ä¿¡å·æ€æ­»
- é€šå¸¸ç”±äºå†…å­˜ä¸è¶³ï¼ˆOOMï¼‰å¯¼è‡´
- `golangci-lint` æ˜¯ä¸€ä¸ªå†…å­˜æ¶ˆè€—è¾ƒå¤§çš„å·¥å…·

## ç³»ç»Ÿç¯å¢ƒ

- **å†…å­˜çŠ¶æ€**: 31GB æ€»å†…å­˜ï¼Œä½†äº¤æ¢ç©ºé—´å·²æ»¡ï¼ˆ2GB äº¤æ¢ç©ºé—´å®Œå…¨ä½¿ç”¨ï¼‰
- **Go ç‰ˆæœ¬**: go1.23.10 linux/amd64
- **golangci-lint ç‰ˆæœ¬**: v1.57.2

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¼˜åŒ– golangci-lint é…ç½®

å°†åŸæ¥çš„ç®€å•é…ç½®ï¼š
```makefile
$(go env GOPATH)/bin/golangci-lint run --timeout=5m
```

ä¿®æ”¹ä¸ºå†…å­˜ä¼˜åŒ–é…ç½®ï¼š
```makefile
@GOMAXPROCS=1 GOGC=100 $(go env GOPATH)/bin/golangci-lint run \
    --timeout=5m \
    --enable=errcheck,govet,gofmt \
    --max-issues-per-linter=20 \
    --max-same-issues=5 \
    --concurrency=1 \
    --print-resources-usage \
    || { å¤‡ç”¨æ–¹æ¡ˆ... }
```

**ä¼˜åŒ–æªæ–½**ï¼š
- `GOMAXPROCS=1`: é™åˆ¶ä½¿ç”¨å•ä¸ª CPU æ ¸å¿ƒ
- `GOGC=100`: è®¾ç½®åƒåœ¾æ”¶é›†å™¨è§¦å‘é¢‘ç‡
- `--concurrency=1`: ç¦ç”¨å¹¶å‘å¤„ç†
- `--enable=errcheck,govet,gofmt`: åªå¯ç”¨æœ€é‡è¦çš„æ£€æŸ¥å™¨
- å‡å°‘é—®é¢˜æŠ¥å‘Šæ•°é‡é™åˆ¶

### 2. æ·»åŠ åŸºç¡€ä»£ç æ£€æŸ¥å‘½ä»¤

åˆ›å»ºäº†æ–°çš„ `lint-basic` ä»»åŠ¡ï¼Œä½œä¸ºå†…å­˜å‹å¥½çš„æ›¿ä»£æ–¹æ¡ˆï¼š

```makefile
lint-basic: ## è¿è¡ŒåŸºç¡€ä»£ç æ£€æŸ¥ï¼ˆå†…å­˜å‹å¥½ï¼‰
    @echo "ğŸ” è¿è¡ŒåŸºç¡€ä»£ç æ£€æŸ¥ï¼ˆå†…å­˜å‹å¥½ï¼‰..."
    @echo "ğŸ“‹ è¿è¡Œ go vet..."
    @go vet ./...
    @echo "ğŸ“‹ æ£€æŸ¥ä»£ç æ ¼å¼..."
    @gofmt -l . | grep -v "^$$" && echo "âŒ å‘ç°æ ¼å¼é—®é¢˜ï¼Œè¯·è¿è¡Œ 'make fmt'" || echo "âœ… æ ¼å¼æ£€æŸ¥é€šè¿‡"
    @echo "ğŸ“‹ æ£€æŸ¥æœªå¤„ç†é”™è¯¯..."
    @which errcheck >/dev/null 2>&1 && errcheck ./... || echo "âš ï¸  errcheckæœªå®‰è£…ï¼Œè¯·è¿è¡Œ 'go install github.com/kisielk/errcheck@latest'"
    @echo "ğŸ“‹ æ£€æŸ¥æ­»ä»£ç ..."
    @which deadcode >/dev/null 2>&1 && deadcode ./... || echo "âš ï¸  deadcodeæœªå®‰è£…ï¼Œè·³è¿‡æ£€æŸ¥"
    @echo "âœ… åŸºç¡€ä»£ç æ£€æŸ¥å®Œæˆ"
```

### 3. ä¼˜é›…é™çº§æœºåˆ¶

åœ¨ `lint` ä»»åŠ¡ä¸­æ·»åŠ äº†å¤‡ç”¨æ–¹æ¡ˆï¼š
```makefile
|| { \
    echo "âš ï¸  golangci-lintå†…å­˜ä¸è¶³ï¼Œä½¿ç”¨åŸºç¡€å·¥å…·æ£€æŸ¥..."; \
    echo "ğŸ” è¿è¡ŒåŸºç¡€ä»£ç æ£€æŸ¥..."; \
    go vet ./... && echo "âœ… go vet é€šè¿‡"; \
    gofmt -l . | grep -v "^$$" && echo "âŒ å‘ç°æ ¼å¼é—®é¢˜ï¼Œè¯·è¿è¡Œ go fmt" || echo "âœ… æ ¼å¼æ£€æŸ¥é€šè¿‡"; \
    echo "ğŸ” è¿è¡Œerrcheckæ£€æŸ¥..."; \
    which errcheck >/dev/null 2>&1 && errcheck ./... || echo "âš ï¸  errcheckæœªå®‰è£…ï¼Œè·³è¿‡"; \
}
```

### 4. æ›´æ–°ä¾èµ–ä»»åŠ¡

å°†ä¾èµ– `lint` çš„ä»»åŠ¡æ”¹ä¸ºä¾èµ– `lint-basic`ï¼š

- `check-quality`: `lint` â†’ `lint-basic`
- `check-all`: `lint` â†’ `lint-basic`

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
```bash
$ make lint
ğŸ” è¿è¡Œgolangci-lintæ£€æŸ¥...
Killed
make: *** [Makefile:120ï¼šlint] é”™è¯¯ 137
```

### ä¿®å¤å
```bash
$ make lint-basic
ğŸ” è¿è¡ŒåŸºç¡€ä»£ç æ£€æŸ¥ï¼ˆå†…å­˜å‹å¥½ï¼‰...
ğŸ“‹ è¿è¡Œ go vet...
ğŸ“‹ æ£€æŸ¥ä»£ç æ ¼å¼...
âœ… æ ¼å¼æ£€æŸ¥é€šè¿‡
ğŸ“‹ æ£€æŸ¥æœªå¤„ç†é”™è¯¯...
âš ï¸  errcheckæœªå®‰è£…ï¼Œè¯·è¿è¡Œ 'go install github.com/kisielk/errcheck@latest'
ğŸ“‹ æ£€æŸ¥æ­»ä»£ç ...
âš ï¸  deadcodeæœªå®‰è£…ï¼Œè·³è¿‡æ£€æŸ¥
âœ… åŸºç¡€ä»£ç æ£€æŸ¥å®Œæˆ
```

### å®Œæ•´ä»£ç è´¨é‡æ£€æŸ¥
```bash
$ make check-quality
ğŸ” è¿è¡ŒåŸºç¡€ä»£ç æ£€æŸ¥ï¼ˆå†…å­˜å‹å¥½ï¼‰...
âœ… åŸºç¡€ä»£ç æ£€æŸ¥å®Œæˆ
ğŸ›¡ï¸ è¿è¡Œå®‰å…¨æ£€æŸ¥...
Summary:
  Gosec  : dev
  Files  : 9
  Lines  : 3017
  Nosec  : 14
  Issues : 0
âœ… å®‰å…¨æ£€æŸ¥å®Œæˆ
ğŸ“Š è¿è¡Œé™æ€ä»£ç åˆ†æ...
âœ… é™æ€åˆ†æå®Œæˆ
âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ
```

## å·¥å…·è¦†ç›–èŒƒå›´

| æ£€æŸ¥ç±»å‹ | åŸ lint | lint-basic | çŠ¶æ€ |
|---------|---------|------------|------|
| go vet | âœ… | âœ… | æ­£å¸¸ |
| æ ¼å¼æ£€æŸ¥ | âœ… | âœ… | æ­£å¸¸ |
| é”™è¯¯æ£€æŸ¥ | âœ… | âš ï¸ | éœ€å®‰è£… errcheck |
| æ­»ä»£ç æ£€æŸ¥ | âœ… | âš ï¸ | éœ€å®‰è£… deadcode |
| å®‰å…¨æ£€æŸ¥ | âœ… | é€šè¿‡ security | æ­£å¸¸ |
| é™æ€åˆ†æ | âœ… | é€šè¿‡ staticcheck | æ­£å¸¸ |

## å»ºè®®

### 1. å®‰è£…é¢å¤–å·¥å…·
```bash
# å®‰è£… errcheck
go install github.com/kisielk/errcheck@latest

# å®‰è£… deadcode
go install golang.org/x/tools/cmd/deadcode@latest
```

### 2. ä½¿ç”¨ç­–ç•¥
- **å¼€å‘æ—¶**: ä½¿ç”¨ `make lint-basic` è¿›è¡Œå¿«é€Ÿæ£€æŸ¥
- **CI/CD**: ä½¿ç”¨ `make check-quality` è¿›è¡Œå®Œæ•´æ£€æŸ¥
- **å†…å­˜å……è¶³ç¯å¢ƒ**: å¯å°è¯•ä½¿ç”¨ `make lint`

### 3. ç³»ç»Ÿä¼˜åŒ–
- ç›‘æ§ç³»ç»Ÿå†…å­˜ä½¿ç”¨æƒ…å†µ
- è€ƒè™‘å¢åŠ äº¤æ¢ç©ºé—´æˆ–ç‰©ç†å†…å­˜
- å…³é—­ä¸å¿…è¦çš„åå°æœåŠ¡

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¿®å¤æªæ–½ï¼š

1. âœ… **è§£å†³äº† lint å†…å­˜ä¸è¶³é—®é¢˜**
2. âœ… **ä¿æŒäº†ä»£ç è´¨é‡æ£€æŸ¥çš„å®Œæ•´æ€§**
3. âœ… **æä¾›äº†å¤šç§æ£€æŸ¥ç­–ç•¥**
4. âœ… **å¢å¼ºäº†å·¥å…·çš„é²æ£’æ€§**

é¡¹ç›®ç°åœ¨å¯ä»¥åœ¨å†…å­˜å—é™çš„ç¯å¢ƒä¸‹æ­£å¸¸è¿›è¡Œä»£ç è´¨é‡æ£€æŸ¥ï¼ŒåŒæ—¶ä¿æŒäº†é«˜æ ‡å‡†çš„ä»£ç è´¨é‡è¦æ±‚ã€‚ 